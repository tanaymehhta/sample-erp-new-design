var Q=Object.defineProperty;var W=(n,s,t)=>s in n?Q(n,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[s]=t;var Y=(n,s,t)=>(W(n,typeof s!="symbol"?s+"":s,t),t);import{c as S,j as e,P as J,m as w,r as x,d as V,B as U,h as X}from"./index-8150de43.js";import{D as O,C as ee}from"./dollar-sign-5b5dfaa5.js";import{U as te,A as se}from"./users-625d434a.js";import{T as A}from"./trending-up-6210fd84.js";import{C as K}from"./chevron-down-d9920b0a.js";import{C as z}from"./calendar-5685a690.js";import{D as re}from"./download-e791cd17.js";const ae=S("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]),ne=S("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]),G=S("Bell",[["path",{d:"M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9",key:"1qo2s2"}],["path",{d:"M10.3 21a1.94 1.94 0 0 0 3.4 0",key:"qgo35s"}]]),oe=S("Target",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["circle",{cx:"12",cy:"12",r:"6",key:"1vlfrh"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}]]),le=S("TrendingDown",[["polyline",{points:"22 17 13.5 8.5 8.5 13.5 2 7",key:"1r2t7k"}],["polyline",{points:"16 17 22 17 22 11",key:"11uiuu"}]]),P=S("Trophy",[["path",{d:"M6 9H4.5a2.5 2.5 0 0 1 0-5H6",key:"17hqa7"}],["path",{d:"M18 9h1.5a2.5 2.5 0 0 0 0-5H18",key:"lmptdp"}],["path",{d:"M4 22h16",key:"57wxv0"}],["path",{d:"M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22",key:"1nw9bq"}],["path",{d:"M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22",key:"1np0yb"}],["path",{d:"M18 2H6v7a6 6 0 0 0 12 0V2Z",key:"u46fv3"}]]),H=S("Zap",[["polygon",{points:"13 2 3 14 12 14 11 22 21 10 12 10 13 2",key:"45s27k"}]]);function T({title:n,value:s,subtitle:t,trend:r,trendValue:a,icon:l,color:m}){const i=()=>{switch(r){case"up":return e.jsx(A,{className:"w-4 h-4"});case"down":return e.jsx(le,{className:"w-4 h-4"});default:return null}},d=()=>{switch(r){case"up":return"text-green-600";case"down":return"text-red-600";default:return"text-gray-500"}};return e.jsx(w.div,{className:"card hover:shadow-lg transition-shadow duration-200",whileHover:{y:-2},initial:{opacity:0,y:20},animate:{opacity:1,y:0},children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-gray-600 mb-1",children:n}),e.jsx("p",{className:"text-2xl font-bold text-gray-900 mb-1",children:s}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("p",{className:"text-xs text-gray-500",children:t}),r&&a&&e.jsxs("div",{className:`flex items-center space-x-1 ${d()}`,children:[i(),e.jsx("span",{className:"text-xs font-medium",children:a})]})]})]}),e.jsx("div",{className:`${m} p-3 rounded-xl flex-shrink-0`,children:l})]})})}function ie(){return e.jsx("div",{className:"card",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded mb-2 animate-pulse"}),e.jsx("div",{className:"h-8 bg-gray-200 rounded mb-2 animate-pulse"}),e.jsx("div",{className:"h-3 bg-gray-200 rounded animate-pulse"})]}),e.jsx("div",{className:"w-12 h-12 bg-gray-200 rounded-xl animate-pulse"})]})})}function ce({stats:n,loading:s=!1}){if(s)return e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:Array.from({length:4}).map((d,h)=>e.jsx(ie,{},h))});const t=d=>d>=1e7?`‚Çπ${(d/1e7).toFixed(1)}Cr`:d>=1e5?`‚Çπ${(d/1e5).toFixed(1)}L`:d>=1e3?`‚Çπ${(d/1e3).toFixed(1)}K`:`‚Çπ${d.toLocaleString()}`,r=d=>d>=1e3?`${(d/1e3).toFixed(1)}K MT`:`${d.toLocaleString()} MT`,a={title:"Total Revenue",value:t(n.totalSales),subtitle:`Target: ${t(n.totalTargetSales)}`,trend:n.periodGrowthRate>0?"up":n.periodGrowthRate<0?"down":"neutral",trendValue:`${n.periodGrowthRate>0?"+":""}${n.periodGrowthRate.toFixed(1)}%`,icon:e.jsx(O,{className:"w-6 h-6 text-green-600"}),color:"bg-green-100"},l={title:"Active Customers",value:n.activeCustomers.toString(),subtitle:`${n.newCustomers} new this period`,trend:n.newCustomers>0?"up":"neutral",trendValue:n.newCustomers>0?`+${n.newCustomers}`:void 0,icon:e.jsx(te,{className:"w-6 h-6 text-blue-600"}),color:"bg-blue-100"},m={title:"Volume Traded",value:r(n.totalVolume),subtitle:`Avg: ${r(n.averageVolume)} per deal`,icon:e.jsx(J,{className:"w-6 h-6 text-purple-600"}),color:"bg-purple-100"},i={title:"Performance",value:`${n.customersExceedingTarget}/${n.activeCustomers}`,subtitle:`${n.customersAtRisk} at risk`,trend:n.customersAtRisk===0?"up":n.customersAtRisk>n.activeCustomers*.3?"down":"neutral",trendValue:n.customersAtRisk>0?`${n.customersAtRisk} risk`:"All good",icon:e.jsx(oe,{className:"w-6 h-6 text-orange-600"}),color:"bg-orange-100"};return e.jsxs(w.div,{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",initial:{opacity:0},animate:{opacity:1},transition:{staggerChildren:.1},children:[e.jsx(T,{...a}),e.jsx(T,{...l}),e.jsx(T,{...m}),e.jsx(T,{...i})]})}function de({customers:n,loading:s=!1}){const[t,r]=x.useState(!1),[a,l]=x.useState("revenue"),m=x.useMemo(()=>n.map(o=>{const c=o.monthlyBreakdown.map((u,N)=>{const M=o.monthlyBreakdown[N-1],C=u.quantity||0,k=M&&M.quantity||0,B=k?(C-k)/k*100:0;return console.log(`Monthly data for ${o.customerName} - ${u.month} ${u.year}:`,{currentVolume:C,prevVolume:k,growth:B}),{month:`${u.month} ${u.year}`,volume:C,growth:B,isProjected:!1}});if(c.length>0){const u=c[c.length-1],N=c.reduce((C,k)=>C+k.growth,0)/c.length,M=u.volume*(1+N/100);c.push({month:"Next Month",volume:M,growth:N,isProjected:!0})}let y=0;if(c.length>=2){const u=c[c.length-2],N=c[c.length-3];u&&N&&N.volume>0&&(y=(u.volume-N.volume)/N.volume*100)}let b="stable";y>15?b="rising":y<-15&&(b="falling");let j={type:"none",magnitude:0};for(let u=1;u<c.length-1;u++){const N=c[u].growth,M=c[u-1].growth,C=Math.abs(N-M);if(C>50){j={type:N>M?"spike":"drop",magnitude:C,month:c[u].month};break}}let D="low";o.riskScore>70?D="high":o.riskScore>40&&(D="medium");const f=c.filter(u=>!u.isProjected),$=f.length>0?f[f.length-1].volume:o.quantity,g=f.length>1?f[f.length-2].volume:0;return{customer:o,monthlyData:c,overallTrend:b,suddenChange:j,riskLevel:D,volumeGrowthRate:y,currentMonthVolume:$,lastMonthVolume:g}}),[n]),i=x.useMemo(()=>[...m].sort((o,c)=>{switch(a){case"revenue":return c.customer.currentPeriodSales-o.customer.currentPeriodSales;case"growth":return c.volumeGrowthRate-o.volumeGrowthRate;case"change":return c.suddenChange.magnitude-o.suddenChange.magnitude;default:return 0}}),[m,a]),d=o=>!o||isNaN(o)||o===0?"0 MT":o>=1e6?`${(o/1e6).toFixed(1)}M MT`:o>=1e3?`${(o/1e3).toFixed(1)}K MT`:`${Math.round(o).toLocaleString()} MT`,h=o=>o>10?e.jsx(ne,{className:"w-4 h-4 text-green-600"}):o<-10?e.jsx(ae,{className:"w-4 h-4 text-red-600"}):e.jsx("div",{className:"w-4 h-4 border border-gray-400 rounded-sm"}),p=o=>o.type==="spike"?e.jsx(H,{className:"w-4 h-4 text-yellow-500"}):o.type==="drop"?e.jsx(V,{className:"w-4 h-4 text-red-500"}):null,v=t?i:i.slice(0,8);return s?e.jsx("div",{className:"card",children:e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-6 bg-gray-200 rounded mb-4"}),e.jsx("div",{className:"space-y-3",children:Array.from({length:6}).map((o,c)=>e.jsxs("div",{className:"flex space-x-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded flex-1"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-20"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-20"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-16"})]},c))})]})}):e.jsxs(w.div,{className:"card",initial:{opacity:0,y:20},animate:{opacity:1,y:0},children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 flex items-center",children:"üì¶ Customer Volume Projection"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"Monthly volume tracking with trend analysis and change detection"})]}),e.jsx("div",{className:"flex items-center space-x-3",children:e.jsxs("select",{value:a,onChange:o=>l(o.target.value),className:"text-sm border border-gray-300 rounded px-3 py-1",children:[e.jsx("option",{value:"revenue",children:"Sort by Volume"}),e.jsx("option",{value:"growth",children:"Sort by Growth"}),e.jsx("option",{value:"change",children:"Sort by Change"})]})})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-gray-200",children:[e.jsx("th",{className:"text-left py-3 px-2 font-medium text-gray-700",children:"Customer"}),e.jsx("th",{className:"text-right py-3 px-2 font-medium text-gray-700",children:"This Month"}),e.jsx("th",{className:"text-right py-3 px-2 font-medium text-gray-700",children:"Last Month"}),e.jsx("th",{className:"text-right py-3 px-2 font-medium text-gray-700",children:"Growth %"}),e.jsx("th",{className:"text-center py-3 px-2 font-medium text-gray-700",children:"Trend"}),e.jsx("th",{className:"text-center py-3 px-2 font-medium text-gray-700",children:"Changes"}),e.jsx("th",{className:"text-center py-3 px-2 font-medium text-gray-700",children:"Risk"})]})}),e.jsx("tbody",{children:v.map((o,c)=>e.jsxs(w.tr,{className:"border-b border-gray-100 hover:bg-gray-50 transition-colors",initial:{opacity:0,x:-10},animate:{opacity:1,x:0},transition:{delay:c*.05},children:[e.jsxs("td",{className:"py-3 px-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${o.overallTrend==="rising"?"bg-green-500":o.overallTrend==="falling"?"bg-red-500":"bg-yellow-500"}`}),e.jsx("span",{className:"font-medium text-gray-900",children:o.customer.customerName})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[o.customer.dealCount," deals ‚Ä¢ ",d(o.customer.quantity||0)," total"]})]}),e.jsxs("td",{className:"py-3 px-2 text-right",children:[e.jsx("div",{className:"font-semibold text-gray-900",children:d(o.currentMonthVolume||0)}),e.jsxs("div",{className:"text-xs text-gray-500",children:[o.customer.dealCount," deals"]})]}),e.jsxs("td",{className:"py-3 px-2 text-right",children:[e.jsx("div",{className:"font-semibold text-gray-600",children:o.lastMonthVolume>0?d(o.lastMonthVolume):"-"}),e.jsx("div",{className:"text-xs text-gray-500",children:o.lastMonthVolume>0?"previous":"no data"})]}),e.jsx("td",{className:"py-3 px-2 text-right",children:e.jsx("div",{className:`font-medium ${o.volumeGrowthRate>0?"text-green-600":o.volumeGrowthRate<0?"text-red-600":"text-gray-600"}`,children:o.volumeGrowthRate===0?"N/A":`${o.volumeGrowthRate>0?"+":""}${o.volumeGrowthRate.toFixed(1)}%`})}),e.jsx("td",{className:"py-3 px-2 text-center",children:h(o.volumeGrowthRate)}),e.jsx("td",{className:"py-3 px-2 text-center",children:p(o.suddenChange)}),e.jsx("td",{className:"py-3 px-2 text-center",children:e.jsx("span",{className:`inline-block w-2 h-2 rounded-full ${o.riskLevel==="high"?"bg-red-500":o.riskLevel==="medium"?"bg-yellow-500":"bg-green-500"}`})})]},o.customer.customerId))})]})}),i.length>8&&e.jsx("div",{className:"mt-4 text-center",children:e.jsxs("button",{onClick:()=>r(!t),className:"inline-flex items-center space-x-2 text-primary-600 hover:text-primary-700 transition-colors",children:[t?e.jsx(K,{className:"w-4 h-4"}):e.jsx(ee,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:t?"Show Less":`Show All ${i.length} Customers`})]})}),e.jsx("div",{className:"mt-4 pt-4 border-t border-gray-200",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-4 text-xs text-gray-500",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full"}),e.jsx("span",{children:"Rising"})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("div",{className:"w-2 h-2 bg-red-500 rounded-full"}),e.jsx("span",{children:"Falling"})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(H,{className:"w-3 h-3 text-yellow-500"}),e.jsx("span",{children:"Sudden Spike"})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(V,{className:"w-3 h-3 text-red-500"}),e.jsx("span",{children:"Sudden Drop"})]})]})})]})}function me({alert:n,onClick:s}){const t=a=>{switch(a){case"risk":return e.jsx(V,{className:"w-4 h-4"});case"opportunity":return e.jsx(A,{className:"w-4 h-4"});case"milestone":return e.jsx(P,{className:"w-4 h-4"});default:return e.jsx(G,{className:"w-4 h-4"})}},r=a=>{switch(a){case"high":return"bg-red-50 border-red-200 text-red-800";case"medium":return"bg-yellow-50 border-yellow-200 text-yellow-800";case"low":return"bg-blue-50 border-blue-200 text-blue-800";default:return"bg-gray-50 border-gray-200 text-gray-800"}};return e.jsx(w.div,{className:`p-3 rounded-lg border cursor-pointer hover:shadow-sm transition-all ${r(n.severity)}`,onClick:()=>s==null?void 0:s(n),whileHover:{scale:1.02},initial:{opacity:0,x:-10},animate:{opacity:1,x:0},children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx("div",{className:"flex-shrink-0 mt-0.5",children:t(n.type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium",children:n.customerName}),e.jsx("p",{className:"text-xs mt-1 opacity-90",children:n.message})]}),n.actionRequired&&e.jsx(se,{className:"w-4 h-4 flex-shrink-0 opacity-60"})]})})}function E({label:n,value:s,trend:t,icon:r}){const a=()=>{switch(t){case"up":return"text-green-600";case"down":return"text-red-600";default:return"text-gray-600"}},l=()=>{switch(t){case"up":return e.jsx(A,{className:"w-3 h-3"});case"down":return e.jsx(A,{className:"w-3 h-3 rotate-180"});default:return null}};return e.jsxs("div",{className:"flex items-center justify-between py-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"text-gray-400",children:r}),e.jsx("span",{className:"text-sm text-gray-700",children:n})]}),e.jsxs("div",{className:`flex items-center space-x-1 ${a()}`,children:[e.jsx("span",{className:"text-sm font-medium",children:s}),l()]})]})}function F({title:n}){return e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900 mb-3",children:n}),e.jsx("div",{className:"space-y-3",children:Array.from({length:3}).map((s,t)=>e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-4 h-4 bg-gray-200 rounded animate-pulse"}),e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsx("div",{className:"h-3 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-2 bg-gray-200 rounded w-2/3 animate-pulse"})]})]},t))})]})}function ue({alerts:n,trends:s,topPerformers:t,loading:r=!1}){const a=i=>i>=1e5?`‚Çπ${(i/1e5).toFixed(1)}L`:i>=1e3?`‚Çπ${(i/1e3).toFixed(1)}K`:`‚Çπ${i.toLocaleString()}`,l=i=>{if(i.length<2)return"stable";const d=i[i.length-1],h=i[i.length-2];return d.sales>h.sales*1.1?"up":d.sales<h.sales*.9?"down":"stable"},m=i=>{if(i.length<2)return"0%";const d=i[i.length-1],h=i[i.length-2],p=(d.sales-h.sales)/h.sales*100;return`${p>0?"+":""}${p.toFixed(1)}%`};return r?e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx(F,{title:"Smart Alerts"}),e.jsx(F,{title:"Performance Trends"}),e.jsx(F,{title:"Top Performers"})]}):e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs(w.div,{className:"card",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.1},children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-sm font-semibold text-gray-900 flex items-center",children:[e.jsx(G,{className:"w-4 h-4 mr-2 text-orange-500"}),"Smart Alerts"]}),n.length>0&&e.jsx("span",{className:"text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded-full",children:n.length})]}),e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:n.length===0?e.jsxs("div",{className:"text-center py-6 text-gray-500",children:[e.jsx(G,{className:"w-8 h-8 mx-auto mb-2 opacity-40"}),e.jsx("p",{className:"text-sm",children:"All good! No alerts."})]}):n.slice(0,5).map(i=>e.jsx(me,{alert:i},i.id))})]}),e.jsxs(w.div,{className:"card",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.2},children:[e.jsxs("h3",{className:"text-sm font-semibold text-gray-900 mb-4 flex items-center",children:[e.jsx(A,{className:"w-4 h-4 mr-2 text-blue-500"}),"Performance Trends"]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(E,{label:"Monthly Growth",value:m(s),trend:l(s),icon:e.jsx(O,{className:"w-4 h-4"})}),e.jsx(E,{label:"Active Customers",value:s.length>0?s[s.length-1].customers.toString():"0",trend:"stable",icon:e.jsx(z,{className:"w-4 h-4"})}),e.jsx(E,{label:"Avg Deal Size",value:s.length>0?a(s[s.length-1].sales/Math.max(s[s.length-1].deals,1)):"‚Çπ0",trend:"up",icon:e.jsx(P,{className:"w-4 h-4"})})]}),s.length>0&&e.jsx("div",{className:"mt-4 p-3 bg-blue-50 rounded-lg",children:e.jsxs("p",{className:"text-xs text-blue-800",children:["üí° ",e.jsx("strong",{children:"Insight:"})," ",l(s)==="up"?"Business is growing steadily":l(s)==="down"?"Consider reviewing customer engagement":"Performance is stable"]})})]}),e.jsxs(w.div,{className:"card",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},children:[e.jsxs("h3",{className:"text-sm font-semibold text-gray-900 mb-4 flex items-center",children:[e.jsx(P,{className:"w-4 h-4 mr-2 text-yellow-500"}),"Top Performers"]}),e.jsx("div",{className:"space-y-3",children:t.length===0?e.jsxs("div",{className:"text-center py-6 text-gray-500",children:[e.jsx(P,{className:"w-8 h-8 mx-auto mb-2 opacity-40"}),e.jsx("p",{className:"text-sm",children:"No data available"})]}):t.slice(0,5).map((i,d)=>e.jsxs(w.div,{className:"flex items-center justify-between py-2 px-3 bg-gray-50 rounded-lg",initial:{opacity:0,x:-10},animate:{opacity:1,x:0},transition:{delay:.1*d},children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("span",{className:"text-lg",children:d===0?"ü•á":d===1?"ü•à":d===2?"ü•â":"üèÖ"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:i.customerName}),e.jsxs("p",{className:"text-xs text-gray-500",children:[i.dealCount," deals"]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:a(i.currentPeriodSales)}),e.jsxs("p",{className:"text-xs text-green-600",children:["+",i.variancePercentage.toFixed(0),"%"]})]})]},i.customerId))})]})]})}function L(n){if(!n)throw new Error("Date string is required");const s=n.split("-");if(s.length!==3)throw new Error(`Invalid date format: ${n}. Expected dd-mm-yyyy`);const t=parseInt(s[0],10),r=parseInt(s[1],10)-1,a=parseInt(s[2],10);if(isNaN(t)||isNaN(r)||isNaN(a))throw new Error(`Invalid date components in: ${n}`);if(t<1||t>31)throw new Error(`Invalid day: ${t} in ${n}`);if(r<0||r>11)throw new Error(`Invalid month: ${s[1]} in ${n}`);if(a<1900||a>2100)throw new Error(`Invalid year: ${a} in ${n}`);const l=new Date(a,r,t);if(l.getDate()!==t||l.getMonth()!==r||l.getFullYear()!==a)throw new Error(`Invalid date: ${n}`);return l}function I(n){const s=String(n.getDate()).padStart(2,"0"),t=String(n.getMonth()+1).padStart(2,"0"),r=n.getFullYear();return`${s}-${t}-${r}`}function _(){const n=new Date,s=new Date(n.getFullYear(),n.getMonth(),1),t=new Date(n.getFullYear(),n.getMonth()+1,0);return{startDate:s,endDate:t}}function R(n){const s=new Date;switch(n){case"thisMonth":{const t=new Date(s.getFullYear(),s.getMonth(),1),r=new Date(s.getFullYear(),s.getMonth()+1,0);return{startDate:t,endDate:r}}case"lastMonth":{const t=new Date(s.getFullYear(),s.getMonth()-1,1),r=new Date(s.getFullYear(),s.getMonth(),0);return{startDate:t,endDate:r}}case"quarter":{const t=Math.floor(s.getMonth()/3),r=new Date(s.getFullYear(),t*3,1),a=new Date(s.getFullYear(),(t+1)*3,0);return{startDate:r,endDate:a}}case"year":{const t=new Date(s.getFullYear(),0,1),r=new Date(s.getFullYear(),11,31);return{startDate:t,endDate:r}}default:return _()}}function he(n,s,t){try{const r=L(n);return r>=s&&r<=t}catch(r){return console.error(`Error parsing date ${n}:`,r),!1}}const q=[{label:"This Month",value:"thisMonth",getDateRange:()=>R("thisMonth")},{label:"Last Month",value:"lastMonth",getDateRange:()=>R("lastMonth")},{label:"This Quarter",value:"quarter",getDateRange:()=>R("quarter")},{label:"This Year",value:"year",getDateRange:()=>R("year")}];function xe({timeRange:n,onChange:s,disabled:t=!1}){const[r,a]=x.useState(!1),[l,m]=x.useState(n.startDate.toISOString().split("T")[0]),[i,d]=x.useState(n.endDate.toISOString().split("T")[0]),h=o=>{if(o==="custom"){a(!0);return}const c=q.find(y=>y.value===o);if(c){const{startDate:y,endDate:b}=c.getDateRange();s({...n,preset:o,startDate:y,endDate:b})}a(!1)},p=()=>{const o=new Date(l),c=new Date(i);o<=c&&(s({...n,preset:"custom",startDate:o,endDate:c}),a(!1))},v=()=>{var o;return n.preset==="custom"?`${I(n.startDate)} - ${I(n.endDate)}`:((o=q.find(c=>c.value===n.preset))==null?void 0:o.label)||"This Month"};return e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:n.preset,onChange:o=>h(o.target.value),disabled:t,className:"appearance-none bg-white border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 disabled:opacity-50 disabled:cursor-not-allowed",children:[q.map(o=>e.jsx("option",{value:o.value,children:o.label},o.value)),e.jsx("option",{value:"custom",children:"Custom Range"})]}),e.jsx(K,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none"})]}),e.jsxs("div",{className:"flex items-center text-sm text-gray-600 bg-gray-50 px-3 py-2 rounded-lg",children:[e.jsx(z,{className:"w-4 h-4 mr-2"}),e.jsx("span",{children:v()})]})]}),r&&e.jsx("div",{className:"absolute top-full left-0 mt-2 bg-white border border-gray-300 rounded-lg shadow-lg p-4 z-10",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Start Date"}),e.jsx("input",{type:"date",value:l,onChange:o=>m(o.target.value),className:"w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-primary-500 focus:border-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"End Date"}),e.jsx("input",{type:"date",value:i,onChange:o=>d(o.target.value),className:"w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-primary-500 focus:border-primary-500"})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{onClick:p,className:"flex-1 bg-primary-600 text-white px-4 py-2 rounded-md hover:bg-primary-700 transition-colors",children:"Apply"}),e.jsx("button",{onClick:()=>a(!1),className:"flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 transition-colors",children:"Cancel"})]})]})})]})}function ge(n,s,t){const r=new Map(s.map(l=>[l.id,l])),a=pe(n);return Array.from(a.entries()).map(([l,m])=>{const i=r.get(l);return i?ye(m,i.name):null}).filter(Boolean)}function pe(n){return n.reduce((s,t)=>(s.has(t.customerId)||s.set(t.customerId,[]),s.get(t.customerId).push(t),s),new Map)}function ye(n,s,t){var $;const r=n.reduce((g,u)=>g+u.totalAmount,0),a=n.reduce((g,u)=>g+u.quantity,0),l=n.length,m=l>0?r/l:0,i=n.sort((g,u)=>new Date(u.dealDate).getTime()-new Date(g.dealDate).getTime()),d=i.length>0?i[0].dealDate:null,h=d?Math.floor((new Date().getTime()-new Date(d).getTime())/(1e3*60*60*24)):0,p=r*.8,v=r-p,o=p>0?v/p*100:0,c=o>10?"up":o<-10?"down":"stable",y=o,b=fe(n),j=we(n),D=je(h,o,l),f=ve(s,h,o,l);return{customerId:(($=n[0])==null?void 0:$.customerId)||"",customerName:s,currentPeriodSales:r,quantity:a,targetSales:p,variance:v,variancePercentage:o,trend:c,growthRate:y,dealCount:l,averageDealSize:m,lastDealDate:d,daysSinceLastDeal:h,monthlyBreakdown:b,productMix:j,riskScore:D,insights:f}}function fe(n){const s=new Map;return n.forEach(t=>{try{const r=L(t.dealDate),a=`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}`;s.has(a)||s.set(a,{sales:0,count:0,quantity:0});const l=s.get(a);l.sales+=t.totalAmount,l.count+=1,l.quantity+=t.quantity}catch(r){console.error("calculateMonthlyBreakdown: Error parsing deal date",t.dealDate,r)}}),console.log("Monthly breakdown data:",s),Array.from(s.entries()).map(([t,r])=>{const[a,l]=t.split("-");return{month:new Date(parseInt(a),parseInt(l)-1).toLocaleDateString("en-US",{month:"short"}),year:parseInt(a),sales:r.sales,quantity:r.quantity,dealCount:r.count,averageDealSize:r.sales/r.count}}).sort((t,r)=>t.year-r.year||parseInt(t.month)-parseInt(r.month))}function we(n){const s=new Map,t=n.reduce((r,a)=>r+a.totalAmount,0);return n.forEach(r=>{s.has(r.productId)||s.set(r.productId,{quantity:0,value:0,name:r.productName});const a=s.get(r.productId);a.quantity+=r.quantity,a.value+=r.totalAmount}),Array.from(s.entries()).map(([r,a])=>({productId:r,productName:a.name,quantity:a.quantity,totalValue:a.value,percentage:t>0?a.value/t*100:0})).sort((r,a)=>a.totalValue-r.totalValue)}function je(n,s,t){let r=0;return n>60?r+=40:n>30?r+=25:n>14&&(r+=10),s<-50?r+=40:s<-25?r+=25:s<-10&&(r+=10),t===0?r+=20:t<3&&(r+=10),Math.min(r,100)}function ve(n,s,t,r){const a=[];return s>30&&a.push(`${n} hasn't ordered in ${s} days - follow up recommended`),t>25?a.push(`${n} is performing exceptionally well with +${t.toFixed(1)}% growth`):t<-25&&a.push(`${n} is significantly below target (${t.toFixed(1)}%) - needs attention`),r<2&&a.push(`${n} has low order frequency - consider engagement strategy`),a}function Ne(n,s){const t=n.reduce((o,c)=>o+c.currentPeriodSales,0),r=n.reduce((o,c)=>o+c.targetSales,0),a=n.filter(o=>o.dealCount>0).length,l=n.filter(o=>o.daysSinceLastDeal<=30).length,m=a>0?t/a:0,i=s.reduce((o,c)=>o+c.quantity,0),d=s.length>0?i/s.length:0,h=r>0?(t-r)/r*100:0,p=n.filter(o=>o.variancePercentage>10).length,v=n.filter(o=>o.riskScore>60).length;return{totalSales:t,totalTargetSales:r,activeCustomers:a,newCustomers:l,averageSalesPerCustomer:m,totalVolume:i,averageVolume:d,periodGrowthRate:h,customersExceedingTarget:p,customersAtRisk:v}}function be(n,s){const t=new Map;return n.forEach(r=>{try{const a=L(r.dealDate),l=`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}`;t.has(l)||t.set(l,{sales:0,customers:new Set,deals:0});const m=t.get(l);m.sales+=r.totalAmount,m.customers.add(r.customerId),m.deals+=1}catch(a){console.error("generateTrendData: Error parsing deal date",r.dealDate,a)}}),Array.from(t.entries()).map(([r,a])=>({period:r,sales:a.sales,customers:a.customers.size,deals:a.deals})).sort((r,a)=>r.period.localeCompare(a.period))}function De(n){const s=[];return n.forEach(t=>{t.riskScore>70&&s.push({id:`risk-${t.customerId}`,type:"risk",customerId:t.customerId,customerName:t.customerName,message:`High risk customer - ${t.daysSinceLastDeal} days since last order`,severity:"high",actionRequired:!0}),t.variancePercentage>50&&s.push({id:`opportunity-${t.customerId}`,type:"opportunity",customerId:t.customerId,customerName:t.customerName,message:"Strong performer - consider upselling opportunities",severity:"medium",actionRequired:!1}),t.currentPeriodSales>1e5&&s.push({id:`milestone-${t.customerId}`,type:"milestone",customerId:t.customerId,customerName:t.customerName,message:`Achieved ‚Çπ${(t.currentPeriodSales/1e5).toFixed(1)}L milestone`,severity:"low",actionRequired:!1})}),s.sort((t,r)=>{const a={high:3,medium:2,low:1};return a[r.severity]-a[t.severity]})}function Ce(n,s){console.log("filterDealsByTimeRange: Filtering",n.length,"deals"),console.log("filterDealsByTimeRange: Time range:",s.startDate,"to",s.endDate);const t=n.filter(r=>{try{const a=he(r.dealDate,s.startDate,s.endDate);return console.log("filterDealsByTimeRange: Deal",r.id,"date",r.dealDate,"in range:",a),a}catch(a){return console.error("filterDealsByTimeRange: Error parsing deal date",r.dealDate,a),!1}});return console.log("filterDealsByTimeRange: Filtered to",t.length,"deals"),t}function Z(){const{startDate:n,endDate:s}=_();return{startDate:n,endDate:s,preset:"thisMonth"}}function Me(n,s={}){const{autoRefresh:t=!1,refreshInterval:r=3e4}=s,[a,l]=x.useState(null),[m,i]=x.useState(!0),[d,h]=x.useState(null),[p,v]=x.useState(Z()),[o,c]=x.useState(null),y=x.useCallback(async()=>{try{console.log("useAnalytics: Starting data fetch..."),i(!0),h(null);const g=await n.getAnalyticsData(p);console.log("useAnalytics: Received analytics data:",g),l(g),o&&!g.customerMetrics.find(u=>u.customerId===o.customerId)&&c(null)}catch(g){h(g instanceof Error?g.message:"Failed to load analytics data"),console.error("Analytics data fetch error:",g)}finally{i(!1)}},[n,p,o]),b=x.useCallback(async()=>{await y()},[y]);x.useEffect(()=>{y()},[y]),x.useEffect(()=>{if(!t)return;const g=setInterval(y,r);return()=>clearInterval(g)},[t,r,y]);const j=x.useCallback(g=>{v(g),c(null)},[]),D=x.useCallback(g=>{c(g)},[]),f=x.useMemo(()=>a!==null&&a.customerMetrics.length>0,[a]),$=x.useMemo(()=>a!==null&&a.customerMetrics.length===0,[a]);return{data:a,loading:m,error:d,timeRange:p,selectedCustomer:o,setTimeRange:j,selectCustomer:D,refreshData:b,hasData:f,isEmpty:$}}class Se{async getDeals(){try{console.log("ApiDealDataProvider: Fetching deals from /api/deals");const s=await fetch("/api/deals");if(!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`);const t=await s.json();if(console.log("ApiDealDataProvider: Raw API response:",t),!t.success)throw new Error(`API Error: ${t.message||"Failed to fetch deals"}`);if(!Array.isArray(t.data))throw new Error("API returned invalid data format - expected array");console.log("ApiDealDataProvider: Processing",t.data.length,"raw deals");const r=t.data.map((a,l)=>{try{if(a.saleParty||console.warn(`Deal ${l}: Missing saleParty, using 'Unknown Customer'`),!a.date)throw new Error(`Deal ${l}: Missing date field`);if(typeof a.quantitySold!="number"||a.quantitySold<=0)throw new Error(`Deal ${l}: Invalid quantitySold: ${a.quantitySold}`);if(typeof a.saleRate!="number"||a.saleRate<=0)throw new Error(`Deal ${l}: Invalid saleRate: ${a.saleRate}`);const m=[a.company,a.grade,a.specificGrade].filter(Boolean).join(" ").trim()||a.productCode||"Unknown Product";return{id:a.id||`deal-${l}`,customerId:a.saleParty||"Unknown Customer",customerName:a.saleParty||"Unknown Customer",productId:a.productCode||"unknown",productName:m,totalAmount:a.quantitySold*a.saleRate,quantity:a.quantitySold,rate:a.saleRate,dealDate:a.date,status:"completed"}}catch(m){console.error(`ApiDealDataProvider: Error processing deal ${l}:`,m,a);const i=m instanceof Error?m.message:"Unknown error";throw new Error(`Invalid deal data at index ${l}: ${i}`)}});return console.log("ApiDealDataProvider: Successfully transformed",r.length,"deals"),r}catch(s){console.error("ApiDealDataProvider: Error fetching/processing deals:",s);const t=s instanceof Error?s.message:"Unknown error";throw new Error(`Failed to load deals: ${t}`)}}async getCustomers(){try{console.log("ApiDealDataProvider: Fetching customers from /api/customers");const s=await fetch("/api/customers");if(!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`);const t=await s.json();if(console.log("ApiDealDataProvider: Raw customers response:",t),!t.success)throw new Error(`API Error: ${t.message||"Failed to fetch customers"}`);if(!Array.isArray(t.data))throw new Error("API returned invalid customer data format - expected array");console.log("ApiDealDataProvider: Processing",t.data.length,"raw customers");const r=t.data.map((a,l)=>{try{const m=a.partyName||a.name;if(!m)throw new Error(`Customer ${l}: Missing partyName/name field`);return{id:m,name:m,contactPerson:a.contactPerson||m,phone:a.phone||"",email:a.email||""}}catch(m){console.error(`ApiDealDataProvider: Error processing customer ${l}:`,m,a);const i=m instanceof Error?m.message:"Unknown error";throw new Error(`Invalid customer data at index ${l}: ${i}`)}});return console.log("ApiDealDataProvider: Successfully transformed",r.length,"customers"),r}catch(s){console.error("ApiDealDataProvider: Error fetching/processing customers:",s);const t=s instanceof Error?s.message:"Unknown error";throw new Error(`Failed to load customers: ${t}`)}}}function $e(){return x.useMemo(()=>(console.log("useDealDataProvider: Using ApiDealDataProvider - NO MOCK DATA"),new Se),[])}class ke{constructor(s,t){Y(this,"config");this.dataProvider=s,this.config={defaultTimeRange:Z(),targetGrowthRate:15,riskThresholdDays:30,topPerformersLimit:5,...t}}async getAnalyticsData(s){const t=s||this.config.defaultTimeRange;try{const[r,a]=await Promise.all([this.dataProvider.getDeals(),this.dataProvider.getCustomers()]),l=Ce(r,t),m=ge(l,a,t),i=Ne(m,l),d=be(l,t),h=De(m);return{customerMetrics:m,summaryStats:i,trends:d,alerts:h,timeRange:t}}catch(r){throw console.error("Error fetching analytics data:",r),new Error("Failed to load analytics data")}}async getCustomerDetails(s,t){return(await this.getAnalyticsData(t)).customerMetrics.find(a=>a.customerId===s)||null}async getTopPerformers(s){return(await this.getAnalyticsData(s)).customerMetrics.sort((r,a)=>a.currentPeriodSales-r.currentPeriodSales).slice(0,this.config.topPerformersLimit)}async getCustomersAtRisk(s){return(await this.getAnalyticsData(s)).customerMetrics.filter(r=>r.riskScore>60).sort((r,a)=>a.riskScore-r.riskScore)}updateConfig(s){this.config={...this.config,...s}}getConfig(){return{...this.config}}}function Ve(){const n=$e(),s=x.useMemo(()=>new ke(n),[n]),{data:t,loading:r,error:a,timeRange:l,setTimeRange:m,refreshData:i,hasData:d,isEmpty:h}=Me(s,{autoRefresh:!0,refreshInterval:6e4}),p=()=>{if(!t){console.warn("No data available for export");return}try{const o=["Customer Name","Current Sales","Previous Sales","Growth Rate","Total Volume","Average Rate","Profit Margin"],c=t.customerMetrics.map(f=>[f.customerName,f.currentPeriodSales.toFixed(2),f.currentPeriodSales.toFixed(2),f.growthRate.toFixed(2),f.quantity.toFixed(2),f.quantity.toFixed(2)]),y=[o.join(","),...c.map(f=>f.join(","))].join(`
`),b=new Blob([y],{type:"text/csv;charset=utf-8;"}),j=document.createElement("a"),D=URL.createObjectURL(b);j.setAttribute("href",D),j.setAttribute("download",`analytics-report-${new Date().toISOString().split("T")[0]}.csv`),j.style.visibility="hidden",document.body.appendChild(j),j.click(),document.body.removeChild(j),console.log("Analytics report exported successfully")}catch(o){console.error("Failed to export analytics report:",o)}},v=x.useMemo(()=>t?t.customerMetrics.sort((o,c)=>c.currentPeriodSales-o.currentPeriodSales).slice(0,5):[],[t]);return e.jsxs(w.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"space-y-8",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 flex items-center",children:[e.jsx(U,{className:"w-8 h-8 mr-3 text-primary-600"}),"Customer Sales Analytics"]}),e.jsx("p",{className:"text-gray-600 mt-2",children:"Real-time customer performance insights and business intelligence"})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs("button",{onClick:i,disabled:r,className:"btn-secondary flex items-center space-x-2",children:[e.jsx(X,{className:`w-4 h-4 ${r?"animate-spin":""}`}),e.jsx("span",{children:"Refresh"})]}),e.jsxs("button",{onClick:p,disabled:!d,className:"btn-primary flex items-center space-x-2",children:[e.jsx(re,{className:"w-4 h-4"}),e.jsx("span",{children:"Export Report"})]})]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(xe,{timeRange:l,onChange:m,disabled:r}),t&&e.jsxs("div",{className:"text-sm text-gray-500",children:["Last updated: ",new Date().toLocaleTimeString()]})]}),a&&e.jsx(w.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"bg-red-50 border border-red-200 rounded-lg p-6",children:e.jsxs("div",{className:"text-red-800",children:[e.jsx("h3",{className:"font-bold text-lg mb-2",children:"‚ùå Analytics Data Error"}),e.jsx("p",{className:"text-sm mb-3 font-medium",children:"What's not working:"}),e.jsx("div",{className:"bg-red-100 p-3 rounded text-sm font-mono",children:a}),e.jsxs("div",{className:"mt-4 text-sm",children:[e.jsx("p",{className:"font-medium",children:"Troubleshooting steps:"}),e.jsxs("ul",{className:"list-disc list-inside mt-2 space-y-1",children:[e.jsx("li",{children:"Check if deals database has data in dd-mm-yyyy format"}),e.jsx("li",{children:"Verify /api/deals and /api/customers endpoints are working"}),e.jsx("li",{children:"Ensure required deal fields: saleParty, date, quantitySold, saleRate"}),e.jsx("li",{children:"Ensure required customer fields: partyName (or name)"}),e.jsx("li",{children:"Check browser console for detailed error logs"})]})]}),e.jsx("button",{onClick:i,className:"mt-4 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition-colors",children:"Try Again"})]})}),h&&!r&&e.jsx(w.div,{initial:{opacity:0},animate:{opacity:1},className:"card",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"bg-blue-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4",children:e.jsx(U,{className:"w-8 h-8 text-blue-500"})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"üìä No deals found for selected time period"}),e.jsxs("p",{className:"text-gray-600 mb-4",children:["No deals were found for the current time range (",I(l.startDate)," - ",I(l.endDate),")"]}),e.jsxs("div",{className:"text-sm text-gray-500 space-y-1",children:[e.jsx("p",{children:"‚úÖ Database connection successful"}),e.jsx("p",{children:"‚úÖ API calls completed successfully"}),e.jsx("p",{children:"‚ÑπÔ∏è Try selecting a different time range or register some deals"})]})]})}),(d||r)&&e.jsxs(e.Fragment,{children:[e.jsx(ce,{stats:(t==null?void 0:t.summaryStats)||{totalSales:0,totalTargetSales:0,activeCustomers:0,newCustomers:0,averageSalesPerCustomer:0,totalVolume:0,averageVolume:0,periodGrowthRate:0,customersExceedingTarget:0,customersAtRisk:0},loading:r}),e.jsx(w.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.2},children:e.jsx(de,{customers:(t==null?void 0:t.customerMetrics)||[],loading:r})}),e.jsxs(w.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Business Intelligence"}),e.jsx("p",{className:"text-gray-600",children:"AI-powered insights, alerts, and performance trends"})]}),e.jsx(ue,{alerts:(t==null?void 0:t.alerts)||[],trends:(t==null?void 0:t.trends)||[],topPerformers:v,loading:r})]})]})]})}export{Ve as default};
